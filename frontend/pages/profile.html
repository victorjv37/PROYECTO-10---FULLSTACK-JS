<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üë§ Mi Perfil - Academia U.A.</title>
    
    
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/pages/profile.css">
    
    
    <link rel="icon" href="../assets/gif almyght.gif">
</head>
<body data-page="profile">
    
    <header id="app-header"></header>

    
    <main class="container py-8">
        
        <div class="profile-header mb-8">
            <div class="card card-deku">
                <div class="card-body">
                    <div class="profile-hero-section">
                        <div class="profile-avatar-section">
                            <div class="profile-avatar-container">
                                <img src="" alt="Avatar" id="profileAvatar" class="profile-avatar">
                                <button onclick="document.getElementById('avatarInput').click()" class="avatar-edit-btn">
                                    üì∑
                                </button>
                                <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="previewAvatar(event)">
                            </div>
                        </div>
                        
                        <div class="profile-info-section">
                            <h1 class="profile-hero-name" id="profileHeroName">---</h1>
                            <p class="profile-real-name" id="profileRealName">---</p>
                            <div class="profile-badges">
                                <span class="badge badge-primary profile-class">---</span>
                                <span class="badge badge-success profile-level-badge">---</span>
                                <span class="badge badge-warning profile-points">--- pts</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        
        <div class="profile-tabs mb-4">
            <button class="tab-btn active" onclick="switchTab('info')">üìã Informaci√≥n</button>
            <button class="tab-btn" onclick="switchTab('quirk')">‚ö° Quirk</button>
            <button class="tab-btn" onclick="switchTab('stats')">üìä Estad√≠sticas</button>
            <button class="tab-btn" onclick="switchTab('trainings')">üí™ Entrenamientos</button>
        </div>

        
        <div id="tab-info" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìã Informaci√≥n Personal</h3>
                    <button onclick="toggleEditMode()" class="btn btn-sm btn-outline" id="editBtn">‚úèÔ∏è Editar</button>
                </div>
                <div class="card-body">
                    <form id="profileForm" class="profile-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Nombre Real</label>
                                <input type="text" id="nombreInput" class="form-input" readonly>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Nombre de H√©roe</label>
                                <input type="text" id="nombreHeroeInput" class="form-input" readonly>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" id="emailInput" class="form-input" readonly disabled>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Clase</label>
                                <input type="text" id="claseInput" class="form-input" readonly disabled>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Nivel</label>
                                <input type="text" id="nivelInput" class="form-input" readonly disabled>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Puntuaci√≥n</label>
                                <input type="text" id="puntuacionInput" class="form-input" readonly disabled>
                            </div>
                        </div>
                        
                        <div id="editActions" class="form-actions" style="display: none;">
                            <button type="submit" class="btn btn-primary">üíæ Guardar Cambios</button>
                            <button type="button" onclick="cancelEdit()" class="btn btn-outline">‚ùå Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        
        <div id="tab-quirk" class="tab-content">
            <div class="card card-deku">
                <div class="card-header">
                    <h3 class="card-title">‚ö° Tu Quirk</h3>
                    <button onclick="toggleEditQuirk()" class="btn btn-sm btn-outline" id="editQuirkBtn">‚úèÔ∏è Editar</button>
                </div>
                <div class="card-body">
                    <form id="quirkForm" class="profile-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Nombre del Quirk</label>
                                <input type="text" id="quirkNombreInput" class="form-input" readonly>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tipo</label>
                                <select id="quirkTipoInput" class="form-select" disabled>
                                    <option value="emision">Emisi√≥n</option>
                                    <option value="transformacion">Transformaci√≥n</option>
                                    <option value="mutacion">Mutaci√≥n</option>
                                </select>
                            </div>
                            
                            <div class="form-group full-width">
                                <label class="form-label">Descripci√≥n</label>
                                <textarea id="quirkDescripcionInput" class="form-textarea" rows="4" readonly></textarea>
                            </div>
                        </div>
                        
                        <div id="editQuirkActions" class="form-actions" style="display: none;">
                            <button type="submit" class="btn btn-primary">üíæ Guardar Quirk</button>
                            <button type="button" onclick="cancelEditQuirk()" class="btn btn-outline">‚ùå Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        
        <div id="tab-stats" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìä Estad√≠sticas de Combate</h3>
                </div>
                <div class="card-body">
                    <div class="stats-display" id="statsDisplay">
                        
                    </div>
                </div>
            </div>
        </div>

        
        <div id="tab-trainings" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üí™ Mis Entrenamientos</h3>
                </div>
                <div class="card-body">
                    <div class="trainings-tabs mb-4">
                        <button class="mini-tab active" onclick="switchTrainingTab('enrolled')">Inscritos</button>
                        <button class="mini-tab" onclick="switchTrainingTab('completed')">Completados</button>
                    </div>
                    
                    <div id="enrolledTrainings" class="training-list">
                        
                    </div>
                    
                    <div id="completedTrainings" class="training-list" style="display: none;">
                        
                    </div>
                </div>
            </div>
        </div>
    </main>

    
    <script src="../utils/api.js" defer></script>
    <script src="../js/main.js" defer></script>
    <script src="../js/components/navbar.js" defer></script>
    <script src="../js/pages/common-auth.js" defer></script>
    
    
    <script>
        let currentUserData = null;
        let isEditMode = false;
        let isEditQuirkMode = false;
        let newAvatar = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadProfileData();
            
            
            document.getElementById('profileForm').addEventListener('submit', saveProfile);
            document.getElementById('quirkForm').addEventListener('submit', saveQuirk);
        });

        async function loadProfileData() {
            try {
                const response = await API.Auth.getProfile();
                console.log('Datos del perfil:', response);
                
                if (response.success && response.data) {
                    currentUserData = response.data;
                    displayProfileData(response.data);
                }
            } catch (error) {
                console.error('Error cargando perfil:', error);
                API.showToast('Error al cargar el perfil', 'error');
            }
        }

        function displayProfileData(user) {
            
            const avatar = user.avatar ? `http://localhost:5000/uploads/${user.avatar}` : API.Utils.getDefaultAvatar(user.nombre);
            document.getElementById('profileAvatar').src = avatar;
            document.getElementById('profileHeroName').textContent = user.nombreHeroe || user.nombre;
            document.getElementById('profileRealName').textContent = `(${user.nombre})`;
            document.querySelector('.profile-class').textContent = user.clase;
            document.querySelector('.profile-level-badge').textContent = `Nivel ${user.nivel}`;
            document.querySelector('.profile-points').textContent = `${user.puntuacion.toLocaleString()} pts`;
            
            
            document.getElementById('nombreInput').value = user.nombre;
            document.getElementById('nombreHeroeInput').value = user.nombreHeroe || '';
            document.getElementById('emailInput').value = user.email;
            document.getElementById('claseInput').value = user.clase;
            document.getElementById('nivelInput').value = user.nivel;
            document.getElementById('puntuacionInput').value = user.puntuacion.toLocaleString();
            
            
            if (user.quirk) {
                document.getElementById('quirkNombreInput').value = user.quirk.nombre;
                document.getElementById('quirkTipoInput').value = user.quirk.tipo;
                document.getElementById('quirkDescripcionInput').value = user.quirk.descripcion;
            }
            
            
            displayStats(user.estadisticas);
            
            
            displayTrainings(user);
        }

        function displayStats(stats) {
            const container = document.getElementById('statsDisplay');
            const abilities = [
                { key: 'fuerza', label: 'Fuerza', icon: 'üí™', color: '#ef4444' },
                { key: 'velocidad', label: 'Velocidad', icon: 'üí®', color: '#3b82f6' },
                { key: 'tecnica', label: 'T√©cnica', icon: 'üéØ', color: '#a855f7' },
                { key: 'inteligencia', label: 'Inteligencia', icon: 'üß†', color: '#06b6d4' },
                { key: 'cooperacion', label: 'Cooperaci√≥n', icon: 'ü§ù', color: '#22c55e' }
            ];

            container.innerHTML = abilities.map(ability => {
                const value = stats[ability.key] || 1;
                const percentage = (value / 10) * 100;
                
                return `
                    <div class="stat-row">
                        <div class="stat-info">
                            <span class="stat-icon">${ability.icon}</span>
                            <span class="stat-name">${ability.label}</span>
                        </div>
                        <div class="stat-bar-container">
                            <div class="stat-bar" style="width: ${percentage}%; background: ${ability.color}"></div>
                        </div>
                        <span class="stat-value">${value}/10</span>
                    </div>
                `;
            }).join('');
        }

        function displayTrainings(user) {
            
            const enrolledContainer = document.getElementById('enrolledTrainings');
            const enrolled = user.entrenamientosAsistidos || [];
            
            if (enrolled.length === 0) {
                enrolledContainer.innerHTML = '<p class="text-muted text-center py-8">No est√°s inscrito en ning√∫n entrenamiento</p>';
            } else {
                enrolledContainer.innerHTML = enrolled.map(t => createTrainingItem(t)).join('');
            }
            
            
            const completedContainer = document.getElementById('completedTrainings');
            const completed = enrolled.filter(t => t.estado === 'completado');
            
            if (completed.length === 0) {
                completedContainer.innerHTML = '<p class="text-muted text-center py-8">A√∫n no has completado ning√∫n entrenamiento</p>';
            } else {
                completedContainer.innerHTML = completed.map(t => createTrainingItem(t)).join('');
            }
        }

        function createTrainingItem(training) {
            return `
                <div class="training-item">
                    <div class="training-item-icon">${getTrainingIcon(training.tipo)}</div>
                    <div class="training-item-info">
                        <h4 class="training-item-title">${training.titulo}</h4>
                        <p class="training-item-meta">
                            üìÖ ${API.Utils.formatDate(training.fechaHora)} ‚Ä¢ 
                            üìç ${training.ubicacion} ‚Ä¢ 
                            ‚è±Ô∏è ${API.Utils.formatDuration(training.duracion)}
                        </p>
                    </div>
                    <span class="badge badge-${training.estado === 'completado' ? 'success' : 'primary'}">
                        ${training.estado}
                    </span>
                </div>
            `;
        }

        function getTrainingIcon(tipo) {
            const icons = {
                'combate': '‚öîÔ∏è',
                'rescate': 'üöë',
                'quirk-development': '‚ö°',
                'resistencia': 'üèÉ',
                'estrategia': 'üß†',
                'trabajo-en-equipo': 'ü§ù',
                'mision-practica': 'üéØ'
            };
            return icons[tipo] || 'üí™';
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            
            document.getElementById('nombreInput').readOnly = !isEditMode;
            document.getElementById('nombreHeroeInput').readOnly = !isEditMode;
            document.getElementById('editActions').style.display = isEditMode ? 'flex' : 'none';
            document.getElementById('editBtn').textContent = isEditMode ? '‚ùå Cancelar' : '‚úèÔ∏è Editar';
        }

        function toggleEditQuirk() {
            isEditQuirkMode = !isEditQuirkMode;
            
            document.getElementById('quirkNombreInput').readOnly = !isEditQuirkMode;
            document.getElementById('quirkTipoInput').disabled = !isEditQuirkMode;
            document.getElementById('quirkDescripcionInput').readOnly = !isEditQuirkMode;
            document.getElementById('editQuirkActions').style.display = isEditQuirkMode ? 'flex' : 'none';
            document.getElementById('editQuirkBtn').textContent = isEditQuirkMode ? '‚ùå Cancelar' : '‚úèÔ∏è Editar';
        }

        function cancelEdit() {
            toggleEditMode();
            displayProfileData(currentUserData);
        }

        function cancelEditQuirk() {
            toggleEditQuirk();
            displayProfileData(currentUserData);
        }

        async function saveProfile(e) {
            e.preventDefault();
            
            const profileData = {
                nombre: document.getElementById('nombreInput').value,
                nombreHeroe: document.getElementById('nombreHeroeInput').value
            };

            try {
                const response = await API.Auth.updateProfile(profileData, newAvatar);
                
                if (response.success) {
                    API.showToast('Perfil actualizado exitosamente', 'success');
                    currentUserData = response.data;
                    displayProfileData(response.data);
                    toggleEditMode();
                    newAvatar = null;
                }
            } catch (error) {
                console.error('Error guardando perfil:', error);
                API.showToast('Error al guardar el perfil', 'error');
            }
        }

        async function saveQuirk(e) {
            e.preventDefault();
            
            const quirkData = {
                quirk: {
                    nombre: document.getElementById('quirkNombreInput').value,
                    tipo: document.getElementById('quirkTipoInput').value,
                    descripcion: document.getElementById('quirkDescripcionInput').value
                }
            };

            try {
                const response = await API.Auth.updateProfile(quirkData);
                
                if (response.success) {
                    API.showToast('Quirk actualizado exitosamente', 'success');
                    currentUserData = response.data;
                    displayProfileData(response.data);
                    toggleEditQuirk();
                }
            } catch (error) {
                console.error('Error guardando quirk:', error);
                API.showToast('Error al guardar el quirk', 'error');
            }
        }

        function previewAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                newAvatar = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('profileAvatar').src = e.target.result;
                };
                reader.readAsDataURL(file);
                API.showToast('Avatar seleccionado. Guarda los cambios para aplicar.', 'info');
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        function switchTrainingTab(type) {
            document.querySelectorAll('.mini-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('enrolledTrainings').style.display = type === 'enrolled' ? 'block' : 'none';
            document.getElementById('completedTrainings').style.display = type === 'completed' ? 'block' : 'none';
        }
    </script>
</body>
</html>
